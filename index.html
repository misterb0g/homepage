<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Homepage</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="/favicon.ico" sizes="any">
</head>
<body>
  <div class="top-controls">
    <button id="theme-toggle-btn" class="btn-icon" aria-pressed="false" title="Basculer clair/sombre (Alt+T)" aria-label="Basculer le thème">
      <svg id="theme-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path d="M12 4.5V2m0 20v-2.5M4.5 12H2m20 0h-2.5M5.6 5.6 4 4m16 16-1.6-1.6M5.6 18.4 4 20m16-16-1.6 1.6"/>
        <circle cx="12" cy="12" r="4.5"/>
      </svg>
    </button>
  </div>

  <div class="container">
    <div id="greeting-container">
      <div id="greeting"></div>
      <div id="clock" aria-label="Heure actuelle"></div>
    </div>

    <section id="weather" class="card glass weather-container" aria-live="polite" tabindex="0" role="button" aria-expanded="false" aria-controls="weather-details" title="Cliquer pour afficher les prévisions 5 jours">
      <div class="skeleton skeleton-text" style="width: 60%; height: 24px;"></div>
    </section>
    <section id="weather-details" class="card glass weather-details" hidden></section>

    <form class="spotlight glass" action="https://www.google.com/search" method="GET" target="_self" role="search" aria-label="Recherche">
      <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5a6.5 6.5 0 10-6.5 6.5c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
      </svg>
      <input type="search" name="q" placeholder="Rechercher…" inputmode="search" autocapitalize="off" autocorrect="off" spellcheck="false" required aria-label="Votre recherche" />
      <button type="submit" class="visually-hidden">Rechercher</button>
    </form>

    <div id="bookmark-container">
      <section class="bookmark-set card glass skeleton">
        <div class="skeleton skeleton-title"></div>
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text"></div>
      </section>
      <section class="bookmark-set card glass skeleton">
        <div class="skeleton skeleton-title"></div>
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text"></div>
      </section>
      <section class="bookmark-set card glass skeleton">
        <div class="skeleton skeleton-title"></div>
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text"></div>
      </section>
      <section class="bookmark-set card glass skeleton">
        <div class="skeleton skeleton-title"></div>
        <div class="skeleton skeleton-text"></div>
      </section>
    </div>

    <div id="chat-container" class="card glass">
      <div class="chat-tabs">
        <button id="tab-gpt" class="chat-tab active" data-target="gpt">ChatGPT</button>
        <button id="tab-gemini" class="chat-tab" data-target="gemini">Gemini</button>
      </div>

      <section id="chat-panel-gpt" class="chat-panel">
        <div class="chat-messages" aria-live="polite"></div>
        <form class="chat-form" id="gpt-form" autocomplete="off">
          <input type="text" name="prompt" placeholder="Question pour ChatGPT…" inputmode="text" required aria-label="Message pour ChatGPT" />
          <button type="submit">Envoyer</button>
        </form>
      </section>

      <section id="chat-panel-gemini" class="chat-panel" hidden>
        <div class="chat-messages" aria-live="polite"></div>
        <form class="chat-form" id="gemini-form" autocomplete="off">
          <input type="text" name="prompt" placeholder="Question pour Gemini…" inputmode="text" required aria-label="Message pour Gemini" />
          <button type="submit">Envoyer</button>
        </form>
      </section>
      
      <p class="hint">Astuce : `/` ou `⌘K` → Recherche • `Alt+C` → Chat • `Alt+T` → Thème</p>
    </div>
  </div>

  <script src="bookmarks.js"></script>
  <script>
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => root.querySelectorAll(sel);

    /* Horloge */
    function getTime() {
      const d = new Date();
      const pad = (n) => (n < 10 ? "0" + n : n);
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    
    /* Message d'accueil */
    function updateGreeting() {
        const hour = new Date().getHours();
        let greetingText = "Bonsoir";
        if (hour < 12) {
            greetingText = "Bonjour";
        } else if (hour < 18) {
            greetingText = "Bon après-midi";
        }
        $('#greeting').textContent = greetingText;
    }

    /* Météo (Open-Meteo) */
    const BRU = { lat: 50.8503, lon: 4.3517, tz: 'Europe/Brussels' };
    const WEATHER_CACHE_KEY = 'weather5d_cache_v1';
    const WEATHER_TTL_MS = 60 * 60 * 1000;

    function getWeather() {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${BRU.lat}&longitude=${BRU.lon}&current=temperature_2m,weather_code&timezone=${encodeURIComponent(BRU.tz)}&forecast_days=1`;
      fetch(url)
        .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
        .then(data => {
          let t = data?.current?.temperature_2m;
          let wcode = data?.current?.weather_code;
          if (t != null) t = Math.round(t);
          if (t == null || wcode == null) throw new Error("Structure inattendue");
          $('#weather').innerHTML = `<div class="row">
            <div id="weather-description" class="inline">${weatherCodeToFr(wcode)}</div>
            <div class="inline">•</div>
            <div id="temp" class="inline">${t} °C</div>
          </div>`;
        })
        .catch(err => {
          console.error("Météo:", err);
          if ($("#weather")) $("#weather").innerHTML = `<div class="inline">Météo indisponible</div>`;
        });
    }

    function getWeather5dCached() {
      try {
        const raw = localStorage.getItem(WEATHER_CACHE_KEY);
        if (raw) {
          const { ts, data } = JSON.parse(raw);
          if (data && Date.now() - ts < WEATHER_TTL_MS) return Promise.resolve(data);
        }
      } catch {}
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${BRU.lat}&longitude=${BRU.lon}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=${encodeURIComponent(BRU.tz)}&forecast_days=5`;
      return fetch(url)
        .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
        .then(data => {
          if (!data?.daily?.time) throw new Error("Structure daily inattendue");
          try { localStorage.setItem(WEATHER_CACHE_KEY, JSON.stringify({ ts: Date.now(), data })); } catch {}
          return data;
        });
    }

    function weatherCodeToFr(code) {
      const map = {0:"Ciel dégagé",1:"Plutôt dégagé",2:"Partiellement nuageux",3:"Couvert",45:"Brouillard",48:"Brouillard givrant",51:"Bruine légère",53:"Bruine",55:"Bruine forte",61:"Pluie légère",63:"Pluie",65:"Pluie forte",66:"Pluie verglaçante légère",67:"Pluie verglaçante forte",71:"Neige légère",73:"Neige",75:"Neige forte",77:"Grains de neige",80:"Averses faibles",81:"Averses",82:"Averses fortes",85:"Averses de neige faibles",86:"Averses de neige fortes",95:"Orages",96:"Orages (grésil)",99:"Orages (grêle)"};
      return map[code] ?? "Météo";
    }

    function renderWeather5d(data) {
      const days = data.daily.time.map((d, i) => ({ date: d, code: data.daily.weather_code[i], tmax: Math.round(data.daily.temperature_2m_max[i]), tmin: Math.round(data.daily.temperature_2m_min[i]) }));
      const df = new Intl.DateTimeFormat('fr-BE', { weekday: 'long', day: 'numeric', month: 'short' });
      const html = ["<div class='weather5d'>", ...days.map((day) => `
        <div class="weather-day">
          <div class="wd-date">${df.format(new Date(day.date))}</div>
          <div class="wd-desc">${weatherCodeToFr(day.code)}</div>
          <div class="wd-temps"><span class="max">${day.tmax}°</span> / <span class="min">${day.tmin}°</span></div>
        </div>`), "</div>"].join("");
      $("#weather-details").innerHTML = html;
    }

    /* Favoris */
    function setupBookmarks() {
      const el = $("#bookmark-container");
      el.innerHTML = bookmarks.map((b) => {
        return `<section class='bookmark-set card glass'>
          <div class="bookmark-title">${b.title}</div>
          <div class="bookmark-inner-container">
            ${b.links.map(l => `<a class="bookmark" href="${l.url}" target="_blank" rel="noopener noreferrer">${l.name}</a>`).join("")}
          </div>
        </section>`;
      }).join("");
    }

    /* Thème */
    (function () {
      const root = document.documentElement;
      const btn = $("#theme-toggle-btn");
      const icon = $("#theme-icon");
      function setIcon(theme) {
        icon.innerHTML = (theme === "light")
          ? '<path d="M12 4.5V2m0 20v-2.5M4.5 12H2m20 0h-2.5M5.6 5.6 4 4m16 16-1.6-1.6M5.6 18.4 4 20m16-16-1.6 1.6"/><circle cx="12" cy="12" r="4.5"/>'
          : '<path d="M21 12.7A9 9 0 1 1 11.3 3a7 7 0 1 0 9.7 9.7z"/>';
      }
      const saved = localStorage.getItem("theme");
      let theme = saved || (matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
      root.setAttribute("data-theme", theme);
      setIcon(theme);
      btn.addEventListener("click", () => {
        theme = (root.getAttribute("data-theme") === "light") ? "dark" : "light";
        root.setAttribute("data-theme", theme);
        localStorage.setItem("theme", theme);
        setIcon(theme);
      });
    })();

    /* Raccourcis Clavier */
    window.addEventListener("keydown", (e) => {
      const activeTag = document.activeElement.tagName.toLowerCase();
      const isInputFocused = activeTag === "input" || activeTag === "textarea";

      // Recherche Google
      if (!isInputFocused) {
          if (e.key === "/" && !e.metaKey && !e.ctrlKey) { 
              e.preventDefault(); 
              $(".spotlight input[type='search']").focus(); 
          }
          if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "k") { 
              e.preventDefault();
              $(".spotlight input[type='search']").focus();
          }
      }

      // Focus Chat
      if (e.altKey && e.key.toLowerCase() === 'c') {
          e.preventDefault();
          const activeChatInput = $('.chat-panel:not([hidden]) .chat-form input');
          if (activeChatInput) {
              activeChatInput.focus();
          }
      }
      
      // Toggle Thème
      if (e.altKey && e.key.toLowerCase() === 't') {
          e.preventDefault();
          $('#theme-toggle-btn').click();
      }
    });

    /* --- Logique des CHATS --- */
    (function() {
      // Fonction utilitaire pour ajouter une bulle de message
      function addBubble(container, text, who, isPending = false) {
        const bubble = document.createElement('div');
        bubble.className = `msg ${who}` + (isPending ? ' pending' : '');
        bubble.textContent = text;
        container.appendChild(bubble);
        container.scrollTop = container.scrollHeight;
        return bubble;
      }

      // 1. Logique des onglets
      const tabs = $$('.chat-tab');
      const panels = $$('.chat-panel');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetId = tab.dataset.target;
          
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          panels.forEach(p => {
            p.hidden = (p.id !== `chat-panel-${targetId}`);
          });
        });
      });

      // 2. Logique ChatGPT (streaming)
      const gptForm = $("#gpt-form");
      const gptInput = gptForm.querySelector('input');
      const gptMessages = $("#chat-panel-gpt .chat-messages");

      gptForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const prompt = gptInput.value.trim();
        if (!prompt) return;
        addBubble(gptMessages, prompt, 'you');
        gptInput.value = '';
        const botBubble = addBubble(gptMessages, '...', 'bot', true);

        try {
          const res = await fetch('/api/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt }) });
          if (!res.ok) throw new Error(`API Error (${res.status}): ${await res.text()}`);
          if (!res.body) throw new Error('No response stream');
          
          const reader = res.body.getReader();
          const decoder = new TextDecoder('utf-8');
          let accumulatedText = '';
          
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            accumulatedText += decoder.decode(value, { stream: true });
            botBubble.textContent = accumulatedText;
            gptMessages.scrollTop = gptMessages.scrollHeight;
          }
          botBubble.classList.remove('pending');
        } catch(err) {
          botBubble.classList.remove('pending');
          botBubble.textContent = `Erreur: ${err.message}`;
          console.error(err);
        }
      });

      // 3. Logique Gemini (non-streaming)
      const geminiForm = $("#gemini-form");
      const geminiInput = geminiForm.querySelector('input');
      const geminiMessages = $("#chat-panel-gemini .chat-messages");

      geminiForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const prompt = geminiInput.value.trim();
        if (!prompt) return;
        addBubble(geminiMessages, prompt, 'you');
        geminiInput.value = '';
        const botBubble = addBubble(geminiMessages, '...', 'bot', true);

        try {
          const res = await fetch('/api/gemini', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt }) });
          
          if (!res.ok) {
            const errorText = await res.text();
            throw new Error(errorText || `Erreur API (${res.status})`);
          }
          
          const data = await res.json();
          botBubble.textContent = data.text || "Pas de réponse textuelle.";

        } catch(err) {
          botBubble.textContent = `Erreur: ${err.message}`;
          console.error(err);
        } finally {
            botBubble.classList.remove('pending');
        }
      });
    })();
    
    /* Interactions météo (toggle détails) */
    (function () {
      const weatherCard = $("#weather");
      const details = $("#weather-details");
      let loaded = false;

      async function toggleDetails() {
        const isHidden = details.hasAttribute("hidden");
        if (isHidden && !loaded) {
          try {
            details.innerHTML = "Chargement des prévisions...";
            const data = await getWeather5dCached();
            renderWeather5d(data);
            loaded = true;
          } catch {
            details.innerHTML = "<div class='wd-error'>Impossible de charger les prévisions.</div>";
          }
        }
        details.toggleAttribute("hidden");
        weatherCard.setAttribute("aria-expanded", String(!details.hasAttribute("hidden")));
      }

      weatherCard.addEventListener("click", toggleDetails);
      weatherCard.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          toggleDetails();
        }
      });
    })();

    /* Init */
    window.addEventListener("load", () => {
      updateGreeting();
      $("#clock").textContent = getTime();
      setInterval(() => {
          $("#clock").textContent = getTime();
          // On vérifie le message d'accueil toutes les minutes
          if (new Date().getSeconds() === 0) {
              updateGreeting();
          }
      }, 1000);
      setupBookmarks();
      getWeather();
    });
  </script>
</body>
</html>