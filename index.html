<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Homepage</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="/favicon.ico" sizes="any">

  <style>
    /* --- Animations globales --- */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px) scale(0.98); filter: blur(8px); }
      to { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
    }
    
    .bookmark-set, #news-container {
      opacity: 0; 
      animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      will-change: transform, opacity, filter;
    }
    #news-container { animation-delay: 0.1s; }

    #weather-details:not([hidden]) {
      animation: fadeInUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    /* --- Gestion de l'affichage News --- */
    /* Permet de masquer tout le bloc news via le panneau de contrôle */
    body.news-hidden #news-container {
        display: none !important;
    }

    /* Grille pour les 2 colonnes de news */
    .news-grid {
        display: grid;
        grid-template-columns: 1fr 1fr; /* 2 colonnes égales */
        gap: 2rem;
    }

    /* Responsive : 1 seule colonne sur mobile */
    @media (max-width: 768px) {
        .news-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
    }
  
    /* --- Spotlight modal : garantir que le menu des moteurs passe AU-DESSUS de l’overlay --- */
    @supports(selector(:has(*))) {
      body:has(.spotlight:focus-within) .engine-menu { z-index: 906; }
    }

  </style>
</head>
<body>
  
  <!-- Icons (monochrome, charte "macOS-ish") -->
  <svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden">
    <symbol id="i-google" viewBox="0 0 24 24">
      <path d="M10 2a8 8 0 1 0 4.9 14.3l4.4 4.4 1.4-1.4-4.4-4.4A8 8 0 0 0 10 2zm0 2a6 6 0 1 1 0 12 6 6 0 0 1 0-12z"/>
    </symbol>
    <symbol id="i-duckduckgo" viewBox="0 0 24 24">
      <path d="M12 4c3 0 5 1.9 5 4.3 0 1.1-.5 2.1-1.3 2.8.9.5 1.8 1.3 2.3 2.4.2.4 0 .9-.4 1.1-.4.2-.9 0-1.1-.4-.5-1-1.6-1.8-2.6-2.1-.4-.1-.6-.5-.6-.9.1-.4.4-.7.8-.7h.1c.8-.1 1.4-.8 1.4-1.8C15.6 7.6 14.2 6 12 6S8.4 7.6 8.4 10c0 1 .6 1.7 1.4 1.8h.1c.4 0 .7.3.8.7.1.4-.2.8-.6.9-1 .3-2.1 1.1-2.6 2.1-.2.4-.7.6-1.1.4-.4-.2-.6-.7-.4-1.1.5-1.1 1.4-1.9 2.3-2.4C7.5 12.1 7 11.1 7 10.3 7 5.9 9.5 4 12 4z"/>
      <path d="M13.2 10.2h2.6c.4 0 .7.3.7.7s-.3.7-.7.7h-1.2l.3.3c.3.3.3.7 0 1s-.7.3-1 0l-1-1c-.2-.2-.3-.4-.2-.7 0-.4.3-.7.7-.7z"/>
    </symbol>
    <symbol id="i-bing" viewBox="0 0 24 24">
      <path d="M6 3v10.8l6.7 3.4 5.3-3.1V7.6l-6-2.4v2.3l3.6 1.5v3.7l-2.9 1.6-3.4-1.8V3H6z"/>
    </symbol>
    <symbol id="i-brave" viewBox="0 0 24 24">
      <path d="M7.4 4.2 12 2l4.6 2.2 2 3.6-.8 9.2L12 22l-5.8-5.1-.8-9.2 2-3.6zm1.2 2.1-1.4 2.6.7 7.4L12 20l4.1-3.7.7-7.4-1.4-2.6L12 4.8 8.6 6.3z"/>
    </symbol>
    <symbol id="i-wikipedia" viewBox="0 0 24 24">
      <path d="M6 4h9a3 3 0 0 1 3 3v13H8a2 2 0 0 0-2 2V6a2 2 0 0 1 2-2zm0 2v14c.6-.6 1.4-1 2.3-1H16V7a1 1 0 0 0-1-1H6z"/>
      <path d="M9 8h6v2H9V8zm0 4h6v2H9v-2z"/>
    </symbol>
    <symbol id="i-amazon" viewBox="0 0 24 24">
      <path d="M7 7h2l.6 10.3c0 .4.3.7.7.7h7.4c.4 0 .7-.3.7-.7L19 9H9.3L9.2 7H20.5a1 1 0 0 1 1 1.1l-1.2 10.2a2 2 0 0 1-2 1.7H10a2 2 0 0 1-2-1.9L7 7z"/>
      <path d="M9 6a3 3 0 0 1 6 0h-2a1 1 0 1 0-2 0H9z"/>
    </symbol>
    <symbol id="i-youtube" viewBox="0 0 24 24">
      <path d="M21 8.2a3 3 0 0 0-2.1-2.1C17.1 5.6 12 5.6 12 5.6s-5.1 0-6.9.5A3 3 0 0 0 3 8.2 31 31 0 0 0 3 12s0 2.4.5 3.8a3 3 0 0 0 2.1 2.1c1.8.5 6.9.5 6.9.5s5.1 0 6.9-.5a3 3 0 0 0 2.1-2.1c.5-1.4.5-3.8.5-3.8s0-2.4-.5-3.8z"/>
      <path d="M10 15.5v-7l6 3.5-6 3.5z" fill="currentColor"/>
    </symbol>
  </svg>

<div class="liquid-background">
    <div class="blob1"></div>
    <div class="blob2"></div>
  </div>

  <div class="top-controls">
    <button id="settings-toggle-btn" class="btn-icon" title="Ouvrir les paramètres">
      <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.06-0.69-1.68-0.91L14.07,3.58 c-0.04-0.24-0.24-0.41-0.48-0.41H9.41c-0.24,0-0.43,0.17-0.48,0.41L8.62,5.7C8,5.92,7.44,6.23,6.94,6.61l-2.39-0.96 c-0.22-0.08-0.47,0-0.59,0.22L2.04,9.19c-0.12,0.2-0.07,0.47,0.12,0.61l2.03,1.58C4.02,11.66,4,11.83,4,12 c0,0.17,0.02,0.34,0.07,0.5l-2.03,1.58c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96 c0.5,0.38,1.06,0.69,1.68,0.91l0.31,2.12c0.04,0.24,0.24,0.41,0.48,0.41h3.18c0.24,0,0.43-0.17,0.48-0.41l0.31-2.12 c0.62-0.22,1.18-0.53,1.68-0.91l2.39,0.96c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12,0.2,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
    </button>
  </div>

  <aside id="control-panel" class="glass" aria-hidden="true">
    <div class="panel-header">
        <h3>Paramètres</h3>
        <button id="panel-close-btn" class="btn-icon" title="Fermer"><svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
    </div>
    <div class="panel-content">
      <div class="panel-section">
          <label for="weather-location-input">Lieu de la météo</label>
          <div class="input-group">
              <input type="text" id="weather-location-input" placeholder="Rechercher…">
              <button id="weather-location-save">OK</button>
          </div>
      </div>
      <div class="panel-section">
          <label>Thème</label>
          <div class="segmented-control" id="theme-selector">

              <button data-value="system" title="Suivre macOS">Auto</button>
              <button data-value="light" title="Thème clair">Jour</button>
              <button data-value="dark" title="Thème sombre">Nuit</button>
          </div>
      </div>
      <div class="panel-section">
          <label>Densité des favoris</label>
          <div class="segmented-control" id="density-selector">
              <button data-value="cozy" title="Normal">Normal</button>
              <button data-value="compact" title="Compact">Compact</button>
          </div>
      </div>
      <div class="panel-section">
          <label for="news-toggle">Afficher les actualités</label>
          <label class="toggle-switch">
              <input type="checkbox" id="news-toggle">
              <span class="slider"></span>
          </label>
      </div>
      <div class="panel-section">
          <label for="chat-toggle">Afficher le module de chat</label>
          <label class="toggle-switch">
              <input type="checkbox" id="chat-toggle">
              <span class="slider"></span>
          </label>
      </div>

      <div class="panel-section">
          <label for="edit-mode-toggle">Mode édition</label>
          <label class="toggle-switch">
              <input type="checkbox" id="edit-mode-toggle">
              <span class="slider"></span>
          </label>
      </div>

      <div class="panel-section">
          <label for="tiles-reset-toggle">Rétablir l’ordre des tuiles</label>
          <label class="toggle-switch">
              <input type="checkbox" id="tiles-reset-toggle">
              <span class="slider"></span>
          </label>
      </div>

      </div>

    </div>
  </aside>
  <div id="overlay" hidden></div>

  <div class="container">
    <div id="greeting-container">
        <div id="greeting"></div>
        <div id="clock"></div>
    </div>

    <section id="weather" class="card glass weather-container" aria-live="polite" tabindex="0" role="button" aria-expanded="false" title="Cliquer pour afficher les prévisions à 5 jours">
        <div class="skeleton skeleton-text" style="width: 60%; height: 24px;"></div>
    </section>
    <section id="weather-details" class="card glass weather-details" hidden></section>
    
    <form id="search-form" class="spotlight glass" action="https://www.google.com/search" method="GET" autocomplete="off">
      <button type="button" id="engine-button" class="engine-button" aria-haspopup="listbox" aria-expanded="false" aria-label="Choisir la cible de recherche" title="Google">
  <svg class="engine-icon" viewBox="0 0 24 24" aria-hidden="true"><use id="engine-icon-use" href="#i-google"></use></svg>
  <span class="engine-caret" aria-hidden="true">▾</span>
</button>
      <div id="engine-menu" class="engine-menu" role="listbox" aria-label="Recherche" hidden>
  <div class="engine-menu-section">Moteurs</div>
  <button type="button" class="engine-option" role="option" data-engine="google">
    <svg class="engine-option-icon" viewBox="0 0 24 24" aria-hidden="true"><use href="#i-google"></use></svg>
    <span>Google</span>
  </button>
  <button type="button" class="engine-option" role="option" data-engine="duckduckgo">
    <svg class="engine-option-icon" viewBox="0 0 24 24" aria-hidden="true"><use href="#i-duckduckgo"></use></svg>
    <span>DuckDuckGo</span>
  </button>
  <button type="button" class="engine-option" role="option" data-engine="bing">
    <svg class="engine-option-icon" viewBox="0 0 24 24" aria-hidden="true"><use href="#i-bing"></use></svg>
    <span>Bing</span>
  </button>
  <button type="button" class="engine-option" role="option" data-engine="brave">
    <svg class="engine-option-icon" viewBox="0 0 24 24" aria-hidden="true"><use href="#i-brave"></use></svg>
    <span>Brave Search</span>
  </button>

  <div class="engine-menu-divider" role="separator" aria-hidden="true"></div>
  <div class="engine-menu-section">Raccourcis</div>

  <button type="button" class="engine-option" role="option" data-engine="wikipedia">
    <svg class="engine-option-icon" viewBox="0 0 24 24" aria-hidden="true"><use href="#i-wikipedia"></use></svg>
    <span>Wikipedia</span>
    <span class="engine-hint">w</span>
  </button>
  <button type="button" class="engine-option" role="option" data-engine="amazon">
    <svg class="engine-option-icon" viewBox="0 0 24 24" aria-hidden="true"><use href="#i-amazon"></use></svg>
    <span>Amazon</span>
    <span class="engine-hint">a</span>
  </button>
  <button type="button" class="engine-option" role="option" data-engine="youtube">
    <svg class="engine-option-icon" viewBox="0 0 24 24" aria-hidden="true"><use href="#i-youtube"></use></svg>
    <span>YouTube</span>
    <span class="engine-hint">y</span>
  </button>
</div>

      <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M10 2a8 8 0 1 0 4.9 14.3l.3.3v.8l5 5 1.4-1.4-5-5h-.8l-.3-.3A8 8 0 0 0 10 2zm0 2a6 6 0 1 1 0 12 6 6 0 0 1 0-12z"/></svg>
      <input type="search" id="search-input" name="q" placeholder="Rechercher, lancer un outil, poser une question…" required>
      <button type="submit" class="visually-hidden">Rechercher</button>
    </form>
    
    <div id="bookmark-container">
        <section class="bookmark-set card glass skeleton"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div></section>
        <section class="bookmark-set card glass skeleton"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div></section>
        <section class="bookmark-set card glass skeleton"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div></section>
        <section class="bookmark-set card glass skeleton"><div class="skeleton skeleton-title"></div></section>
    </div>

    <section id="news-container" class="card glass" style="width: min(920px, 94%); margin: 2rem auto 2.2rem; padding: 1.5rem; display: none;">
      <div class="news-grid">
          <div id="macg-column">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: var(--fg); border-bottom: 2px solid var(--border); padding-bottom: 0.5rem;">
                  MacGeneration
              </h3>
              <div id="macg-list" style="display: grid; gap: 0.8rem;"></div>
          </div>

          <div id="lesoir-column">
              <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: var(--fg); border-bottom: 2px solid var(--border); padding-bottom: 0.5rem;">
                  Le Soir
              </h3>
              <div id="lesoir-list" style="display: grid; gap: 0.8rem;"></div>
          </div>
      </div>
    </section>
    
    <div id="chat-container" class="card glass">
      <div class="chat-tabs">
          <button class="chat-tab active" data-target="gpt">ChatGPT</button>
          <button class="chat-tab" data-target="gemini">Gemini</button>
      </div>
      <section id="chat-panel-gpt" class="chat-panel">
          <div class="chat-messages"></div>
          <form class="chat-form" id="gpt-form"><input type="text" name="prompt" placeholder="Discuter avec ChatGPT…"/><button type="submit">Envoyer</button></form>
      </section>
      <section id="chat-panel-gemini" class="chat-panel" hidden>
          <div class="chat-messages"></div>
          <form class="chat-form" id="gemini-form"><input type="text" name="prompt" placeholder="Discuter avec Gemini…"/><button type="submit">Envoyer</button></form>
      </section>
      <p class="hint">Astuce : `/` ou `⌘K` → Recherche • `Alt+C` → Chat</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="bookmarks.js"></script>
  <script>

    // --- Utilitaires ---

// --- Chat : valeur par défaut (masqué par défaut) ---
if (localStorage.getItem('showChat') === null) {
  localStorage.setItem('showChat', 'false');
}


    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => root.querySelectorAll(sel);
    function getTime() { const d = new Date(), pad = (n) => (n < 10 ? "0" + n : n); return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
    function updateGreeting() { const h = new Date().getHours(); $('#greeting').textContent = (h >= 5 && h < 12) ? "Bonjour" : (h >= 12 && h < 18) ? "Bon après-midi" : "Bonsoir"; }

    

    // --- Ré-ordonnancement des tuiles (Drag & Drop style macOS) ---
    const TILE_ORDER_KEY = "startpage_tile_order_v1";

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[m]));
    }

    function loadTileOrder() {
      try {
        const raw = localStorage.getItem(TILE_ORDER_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    function saveTileOrderFromDOM() {
      const titles = Array.from($$("#bookmark-container .bookmark-set"))
        .map(el => el.getAttribute("data-tile-title"))
        .filter(Boolean);
      try { localStorage.setItem(TILE_ORDER_KEY, JSON.stringify(titles)); } catch {}
    }

    function resetTileOrder() {
      try { localStorage.removeItem(TILE_ORDER_KEY); } catch {}
    }

    function initTileSortable() {
  const container = $("#bookmark-container");
  if (!container) return;

  // Déjà initialisé ?
  if (window.__tileSortable) {
    window.__tileSortable.destroy();
    window.__tileSortable = null;
  }

  if (typeof Sortable === "undefined") {
    console.warn("SortableJS non chargé : drag & drop désactivé.");
    return;
  }

  window.__tileSortable = new Sortable(container, {
    animation: 150,
    easing: "cubic-bezier(.2,.9,.2,1)",
    handle: ".tile-handle",
    draggable: ".bookmark-set",
    ghostClass: "tile-ghost",
    chosenClass: "tile-chosen",
    dragClass: "tile-dragging",
    forceFallback: false, // fallback seulement si nécessaire
    swapThreshold: 0.65,
    onEnd: (evt) => {
      // Petit rebond façon Finder au drop
      const item = evt.item;
      item.classList.add("tile-bounce");
      setTimeout(() => item.classList.remove("tile-bounce"), 180);
      saveTileOrderFromDOM();
    }
  });

  // Respect du Mode édition : par défaut désactivé tant que le toggle n’est pas ON
  const isEdit = document.body.classList.contains("edit-mode");
  window.__tileSortable.option("disabled", !isEdit);
}

function setTileSortableEnabled(enabled) {
  if (!window.__tileSortable) return;
  window.__tileSortable.option("disabled", !enabled);
}

// --- Météo ---
    async function getWeather() {
        const locationName = localStorage.getItem('weatherLocation') || 'Brussels';
        const weatherEl = $('#weather');
        weatherEl.innerHTML = `<div class="skeleton skeleton-text"></div>`;
        try {
            const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(locationName)}&count=1&language=fr&format=json`);
            if (!geoRes.ok) throw new Error('Erreur Geocoding');
            const geoData = await geoRes.json();
            if (!geoData.results || geoData.results.length === 0) throw new Error(`Ville '${locationName}' non trouvée`);
            
            const { latitude, longitude, name } = geoData.results[0];
            const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code&timezone=auto&forecast_days=1`);
            if (!weatherRes.ok) throw new Error('Erreur Météo');
            
            const data = await weatherRes.json();
            let t = data?.current?.temperature_2m, wcode = data?.current?.weather_code;
            
            weatherEl.innerHTML = `<div class="row"><div id="weather-location" class="inline">${name}</div><div class="inline">•</div><div class="inline">${weatherCodeToFr(wcode)}</div><div class="inline">•</div><div class="inline">${Math.round(t)} °C</div></div>`;
        } catch (err) { console.error("Météo:", err); weatherEl.innerHTML = `<div class="inline">${err.message}</div>`; }
    }
    function weatherCodeToFr(code) { const map={0:"Ciel dégagé",1:"Plutôt dégagé",2:"Partiellement nuageux",3:"Couvert",45:"Brouillard",48:"Brouillard givrant",51:"Bruine",61:"Pluie",63:"Pluie forte",71:"Neige",73:"Neige forte",80:"Averses",81:"Averses fortes",95:"Orages"}; return map[code] ?? "Météo"; }
    
    // --- Météo détaillée (5 jours) ---
    (function () {
      const weatherCard = $("#weather"), details = $("#weather-details"); let loaded = false; 
      const WEATHER_CACHE_KEY = 'weather5d_cache_v1', WEATHER_TTL_MS = 3600000;

      async function getWeather5dCached() {
        try { const raw = localStorage.getItem(WEATHER_CACHE_KEY); if (raw) { const { ts, data, location } = JSON.parse(raw); const currentLocation = localStorage.getItem('weatherLocation') || 'Brussels'; if (data && (Date.now() - ts < WEATHER_TTL_MS) && location === currentLocation) return data; } } catch {}
        
        const locationName = localStorage.getItem('weatherLocation') || 'Brussels';
        const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(locationName)}&count=1&language=fr&format=json`);
        const geoData = await geoRes.json();
        const { latitude, longitude } = geoData.results[0];
        
        const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=5`);
        const data = await weatherRes.json();
        try { localStorage.setItem(WEATHER_CACHE_KEY, JSON.stringify({ ts: Date.now(), data, location: locationName })); } catch {}
        return data;
      }

      function renderWeather5d(data) { 
        const days = data.daily.time.map((d, i) => ({ date: d, code: data.daily.weather_code[i], tmax: Math.round(data.daily.temperature_2m_max[i]), tmin: Math.round(data.daily.temperature_2m_min[i]) })); 
        const df = new Intl.DateTimeFormat('fr-BE', { weekday: 'long', day: 'numeric', month: 'short' }); 
        details.innerHTML = `<div class='weather5d'>${days.map(day => `<div class="weather-day"><div class="wd-date">${df.format(new Date(day.date))}</div><div class="wd-desc">${weatherCodeToFr(day.code)}</div><div class="wd-temps"><span class="max">${day.tmax}°</span> / <span class="min">${day.tmin}°</span></div></div>`).join("")}</div>`; 
      }

      async function toggleDetails() { 
        const isHidden = details.hasAttribute("hidden"); 
        if (isHidden && !loaded) { 
            try { details.innerHTML = "Chargement…"; const data = await getWeather5dCached(); renderWeather5d(data); loaded = true; } 
            catch (e) { details.innerHTML = `<div class='wd-error'>Prévisions indisponibles</div>`; } 
        } 
        details.toggleAttribute("hidden"); weatherCard.setAttribute("aria-expanded", String(!details.hasAttribute("hidden"))); 
      }
      weatherCard.addEventListener("click", toggleDetails);
      weatherCard.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleDetails(); } });
    })();

    // --- Favoris ---
    function setupBookmarks() {
      if (typeof bookmarks === 'undefined') return;

      // Tri A→Z des liens dans chaque tuile
      bookmarks.forEach(category => { category.links.sort((a, b) => a.name.localeCompare(b.name)); });

      // Applique l’ordre mémorisé (si présent)
      const order = loadTileOrder();
      if (order && order.length) {
        const byTitle = new Map(bookmarks.map(b => [b.title, b]));
        const ordered = [];
        order.forEach(t => { if (byTitle.has(t)) ordered.push(byTitle.get(t)); });
        // Ajoute ce qui n’est pas encore dans l’ordre (nouvelles tuiles)
        bookmarks.forEach(b => { if (!order.includes(b.title)) ordered.push(b); });
        // Remplace en place (pour éviter de casser les refs ailleurs)
        bookmarks.length = 0;
        ordered.forEach(b => bookmarks.push(b));
      }

      const el = $("#bookmark-container");
      el.innerHTML = bookmarks.map((b, index) => `
        <section class="bookmark-set card glass" data-tile-title="${escapeHtml(b.title)}" style="animation-delay: ${200 + (index * 100)}ms">
          <div class="bookmark-header">
            <div class="bookmark-title">${escapeHtml(b.title)}</div>
            <button class="tile-handle" type="button" aria-label="Déplacer la tuile" title="Déplacer">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M9 5.5A1.5 1.5 0 1 1 7.5 4 1.5 1.5 0 0 1 9 5.5Zm0 6A1.5 1.5 0 1 1 7.5 10 1.5 1.5 0 0 1 9 11.5Zm0 6A1.5 1.5 0 1 1 7.5 16 1.5 1.5 0 0 1 9 17.5ZM16.5 7A1.5 1.5 0 1 1 18 5.5 1.5 1.5 0 0 1 16.5 7Zm0 6A1.5 1.5 0 1 1 18 11.5 1.5 1.5 0 0 1 16.5 13Zm0 6A1.5 1.5 0 1 1 18 17.5 1.5 1.5 0 0 1 16.5 19Z"></path>
              </svg>
            </button>
          </div>
          <div class="bookmark-inner-container">
            ${b.links.map(l => `<a class="bookmark" href="${l.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(l.name)}</a>`).join("")}
          </div>
        </section>`).join("");

      initTileSortable();
    }

    // --- NEWS: Fonction générique pour charger un flux ---
    async function fetchAndRenderNews(apiUrl, listId) {
        const list = $(listId);
        try {
            const res = await fetch(apiUrl);
            if (!res.ok) throw new Error(`Erreur HTTP ${res.status}`);
            
            const xmlText = await res.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");
            
            // Récupération et tri des items (plus récent en haut)
            let items = Array.from(xmlDoc.querySelectorAll("item"));
            items.sort((a, b) => {
                const dateA = new Date(a.querySelector("pubDate")?.textContent);
                const dateB = new Date(b.querySelector("pubDate")?.textContent);
                return dateB - dateA; // Décroissant
            });

            // On garde les 5 premiers pour chaque colonne
            items = items.slice(0, 5);

            if (items.length > 0) {
                list.innerHTML = items.map(item => {
                    const title = item.querySelector("title")?.textContent || "Sans titre";
                    const link = item.querySelector("link")?.textContent || "#";
                    const pubDateRaw = item.querySelector("pubDate")?.textContent;
                    
                    let dateStr = "";
                    if (pubDateRaw) {
                        dateStr = new Date(pubDateRaw).toLocaleDateString('fr-FR', {day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit'});
                    }

                    return `
                    <a href="${link}" target="_blank" rel="noopener" style="text-decoration: none; color: inherit; display: block;">
                        <article class="bookmark" style="height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                            <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.3rem; line-height: 1.4;">${title}</div>
                            <div style="font-size: 0.75rem; color: var(--secondaryFg); text-align: right;">${dateStr}</div>
                        </article>
                    </a>`;
                }).join('');
            } else {
                list.innerHTML = `<div style="font-size:0.8rem; opacity:0.7">Aucun article.</div>`;
            }
        } catch (e) {
            console.error(`Erreur chargement news (${apiUrl}):`, e);
            list.innerHTML = `<div style="font-size:0.8rem; color:var(--errorFg)">Erreur chargement.</div>`;
        }
    }

    // --- Chargement global des news ---
    async function loadNews() {
        const container = $('#news-container');
        
        // On lance les deux requêtes en parallèle pour la rapidité
        await Promise.all([
            fetchAndRenderNews('/api/news', '#macg-list'),    // MacGeneration
            fetchAndRenderNews('/api/lesoir', '#lesoir-list') // Le Soir
        ]);
        
        // Affichage du bloc si l'option est activée
        if (localStorage.getItem('showNews') !== 'false') {
            container.style.display = 'block';
        }
    }

    // --- Barre de recherche intelligente ---
    (function() {
        
        // --- Recherche (moteur sélectionnable via clic sur le "G") ---
        const SEARCH_DEFAULT_ENGINE_KEY = "startpage_search_default_engine_v1";

        // Placeholder "Spotlight-like" (stable, quel que soit le moteur)
        const BASE_PLACEHOLDER = "Rechercher, lancer un outil, poser une question…";

        const PREFIX_ENGINES = {
          "w ": { url: "https://fr.wikipedia.org/w/index.php", queryParam: "search", placeholder: "Rechercher sur Wikipédia..." },
          "a ": { url: "https://www.amazon.fr/s", queryParam: "k", placeholder: "Rechercher sur Amazon..." },
          "y ": { url: "https://www.youtube.com/results", queryParam: "search_query", placeholder: "Rechercher sur YouTube..." }
        };

        const ENGINES = {
  google:     { iconId: "i-google",     name: "Google",       url: "https://www.google.com/search", queryParam: "q" },
  duckduckgo: { iconId: "i-duckduckgo", name: "DuckDuckGo",    url: "https://duckduckgo.com/",      queryParam: "q" },
  bing:       { iconId: "i-bing",       name: "Bing",         url: "https://www.bing.com/search",  queryParam: "q" },
  brave:      { iconId: "i-brave",      name: "Brave",        url: "https://search.brave.com/search", queryParam: "q" },

  // Raccourcis (aussi accessibles via préfixe dans la barre)
  wikipedia:  { iconId: "i-wikipedia",  name: "Wikipedia",    url: "https://fr.wikipedia.org/w/index.php", queryParam: "search" },
  amazon:     { iconId: "i-amazon",     name: "Amazon",       url: "https://www.amazon.com.be/s",      queryParam: "k" },
  youtube:    { iconId: "i-youtube",    name: "YouTube",      url: "https://www.youtube.com/results", queryParam: "search_query" }
};

        const searchForm   = $("#search-form");
        const searchInput  = $("#search-input");
        const engineBtn    = $("#engine-button");
        const engineIconUse = $("#engine-icon-use");
                const engineMenu   = $("#engine-menu");

        /* Engine menu focus keeper */
        function keepSpotlightFocused(){
          // Safari: conserve le mode Spotlight (focus-within) quand on ouvre le menu
          try { searchInput && searchInput.focus({ preventScroll: true }); } catch(e) { try { searchInput && searchInput.focus(); } catch(_){} }
        }

        const engineOptions = $$(".engine-option", engineMenu);

        function getDefaultEngineId() {
          const saved = localStorage.getItem(SEARCH_DEFAULT_ENGINE_KEY);
          return (saved && ENGINES[saved]) ? saved : "google";
        }

        function setDefaultEngineId(engineId) {
          if (!ENGINES[engineId]) return;
          localStorage.setItem(SEARCH_DEFAULT_ENGINE_KEY, engineId);
          applyDefaultEngine(engineId);
        }

        function setEngineIcon(iconId) {
  const href = "#" + (iconId || "i-google");
  // Safari: on met href ET xlink:href
  engineIconUse.setAttribute("href", href);
  engineIconUse.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", href);
}

function applyDefaultEngine(engineId) {
          const engine = ENGINES[engineId] || ENGINES.google;
          searchForm.action = engine.url;
          searchInput.name  = engine.queryParam;
          setEngineIcon(engine.iconId);
          engineBtn.title = engine.name;
          // On garde ton hint "w / a" dans le placeholder (mais on adapte le début)
          const suffix = ", ou 'w ' Wikipedia, 'a ' Amazon, 'y ' YouTube…";
searchInput.placeholder = BASE_PLACEHOLDER;
          engineOptions.forEach((btn) => {
            const active = btn.dataset.engine === engineId;
            btn.classList.toggle("is-active", active);
            btn.setAttribute("aria-selected", active ? "true" : "false");
          });
        }

        function openEngineMenu() {
          engineMenu.hidden = false;
          engineBtn.setAttribute("aria-expanded", "true");
          document.body.classList.add("engine-open");
          // focus sur l'option active (comportement "menu" propre)
          const current = getDefaultEngineId();
          const activeBtn = engineOptions.find(b => b.dataset.engine === current) || engineOptions[0];
          activeBtn?.focus();
        }

        function closeEngineMenu({ focusButton = false } = {}) {
          engineMenu.hidden = true;
          engineBtn.setAttribute("aria-expanded", "false");
          document.body.classList.remove("engine-open");
          if (focusButton) engineBtn.focus();
        }

        function toggleEngineMenu() {
          if (engineMenu.hidden) openEngineMenu();
          else closeEngineMenu({ focusButton: true });
        }

        // init
        applyDefaultEngine(getDefaultEngineId());

        engineBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          toggleEngineMenu();
        });

        engineOptions.forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            const id = btn.dataset.engine;
            setDefaultEngineId(id);
            closeEngineMenu({ focusButton: true });
            searchInput.focus();
          });
        });

        // click dehors / ESC
        document.addEventListener("click", (e) => {
          if (engineMenu.hidden) return;
          const target = e.target;
          if (engineMenu.contains(target) || engineBtn.contains(target)) return;
          closeEngineMenu();
        });
        window.addEventListener("keydown", (e) => {
          if (engineMenu.hidden) return;
          if (e.key === "Escape") {
            e.preventDefault();
            closeEngineMenu({ focusButton: true });
          }
        });

        // Détection des préfixes (w / a / y) : override ponctuel sans changer ton moteur par défaut
        function detectPrefixEngine(query) {
          const keys = Object.keys(PREFIX_ENGINES);
          return keys.find((p) => query.startsWith(p)) || null;
        }

        searchInput.addEventListener("input", () => {
          const q = searchInput.value || "";
          const prefix = detectPrefixEngine(q);
          if (prefix) {
            const engine = PREFIX_ENGINES[prefix];
            searchForm.action = engine.url;
            searchInput.name = engine.queryParam;
            // Placeholder contextuel (sans écraser l'entrée)
            searchInput.placeholder = BASE_PLACEHOLDER;
          } else {
            applyDefaultEngine(getDefaultEngineId());
          }
        });

        searchForm.addEventListener("submit", (e) => {
          const q = (searchInput.value || "").trim();
          const prefix = detectPrefixEngine(q);
          if (!prefix) return; // moteur par défaut déjà appliqué
          // Nettoyage de la requête : on retire le préfixe
          searchInput.value = q.substring(prefix.length).trim();
        });
// Raccourcis clavier
        window.addEventListener("keydown", (e) => { 
            const activeTag = document.activeElement.tagName.toLowerCase(), isInputFocused = activeTag === "input" || activeTag === "textarea"; 
            if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "k") { e.preventDefault(); searchInput.focus(); } 
            if (isInputFocused) return; 
            if (e.key === "/") { e.preventDefault(); searchInput.focus(); } 
            if (e.altKey && e.key.toLowerCase() === 'c') { e.preventDefault(); const input = $('.chat-panel:not([hidden]) .chat-form input'); if (input) input.focus(); } 
        });
    })();

    // --- Chat Logic ---
    (function() {
      let gptHistory = [{ role: 'system', content: 'Tu es un assistant utile et concis. Réponds en français.' }], geminiHistory = [{ role: 'system', content: 'Tu es un assistant utile et concis. Réponds en français.' }];
      function addBubble(container, text, who) { const bubble = document.createElement('div'); bubble.className = `msg ${who}`; bubble.textContent = text; container.appendChild(bubble); container.scrollTop = container.scrollHeight; return bubble; }
      
      const tabs = $$('.chat-tab'), panels = $$('.chat-panel');
      tabs.forEach(tab => { tab.addEventListener('click', () => { const targetId = tab.dataset.target; tabs.forEach(t => t.classList.remove('active')); tab.classList.add('active'); panels.forEach(p => p.hidden = (p.id !== `chat-panel-${targetId}`)); }); });
      
      async function handleChatSubmit(e, history, messagesContainer, apiEndpoint) { 
          e.preventDefault(); const form = e.target, input = form.querySelector('input'), prompt = input.value.trim(); 
          if (!prompt) return; 
          addBubble(messagesContainer, prompt, 'you'); history.push({ role: 'user', content: prompt }); input.value = ''; 
          const botBubble = addBubble(messagesContainer, '…', 'bot'); botBubble.classList.add('pending'); 
          try { 
              const res = await fetch(apiEndpoint, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ messages: history }) }); 
              if (!res.ok) { const errText = await res.text(); throw new Error(JSON.parse(errText).error || errText); } 
              const data = await res.json(); 
              botBubble.textContent = data.text; history.push({ role: 'assistant', content: data.text }); 
          } catch(err) { botBubble.textContent = `Erreur: ${err.message}`; } 
          finally { botBubble.classList.remove('pending'); } 
      }
      $('#gpt-form').addEventListener('submit', (e) => handleChatSubmit(e, gptHistory, $("#chat-panel-gpt .chat-messages"), '/api/chat'));
      $('#gemini-form').addEventListener('submit', (e) => handleChatSubmit(e, geminiHistory, $("#chat-panel-gemini .chat-messages"), '/api/gemini'));
    })();
    
    // --- Panneau de configuration ---
    (function() {
        const panel = $('#control-panel'), overlay = $('#overlay'); const toggleBtn = $('#settings-toggle-btn'), closeBtn = $('#panel-close-btn');
        function openPanel() { panel.setAttribute('aria-hidden', 'false'); overlay.hidden = false; document.body.classList.add('panel-open'); }
        function closePanel() { panel.setAttribute('aria-hidden', 'true'); overlay.hidden = true; document.body.classList.remove('panel-open'); }
        toggleBtn.addEventListener('click', openPanel); closeBtn.addEventListener('click', closePanel); overlay.addEventListener('click', closePanel);
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && document.body.classList.contains('panel-open')) closePanel(); });
        
        // Météo Localisation
        const locationInput = $('#weather-location-input'), saveBtn = $('#weather-location-save'); locationInput.value = localStorage.getItem('weatherLocation') || '';
        const saveLocation = () => { const newLocation = locationInput.value.trim(); if (newLocation) { localStorage.setItem('weatherLocation', newLocation); getWeather(); closePanel(); } };
        saveBtn.addEventListener('click', saveLocation); locationInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') saveLocation(); });
        
        // Paramètres Génériques
        const root = document.documentElement; function applySetting(key, value, action) { localStorage.setItem(key, value); action(value); }
        function setupSelector(selectorId, storageKey, action, defaultValue) { 
            const selector = $(selectorId), buttons = selector.querySelectorAll('button'); 
            const savedValue = localStorage.getItem(storageKey) || defaultValue; action(savedValue); 
            buttons.forEach(b => b.classList.toggle('active', b.dataset.value === savedValue)); 
            selector.addEventListener('click', (e) => { const target = e.target.closest('button'); if (target?.dataset.value) { applySetting(storageKey, target.dataset.value, action); buttons.forEach(b => b.classList.remove('active')); target.classList.add('active'); } }); 
        }
        // Thème : 'system' suit macOS (prefers-color-scheme)
        const colorSchemeMQ = window.matchMedia("(prefers-color-scheme: dark)");
        function resolveSystemTheme(){ return colorSchemeMQ.matches ? "dark" : "light"; }
        function applyTheme(pref){
          const effective = (pref === "system") ? resolveSystemTheme() : pref;
          root.setAttribute("data-theme", effective);
          root.setAttribute("data-theme-pref", pref);
        }
        try {
          colorSchemeMQ.addEventListener("change", () => {
            if ((localStorage.getItem("theme") || "system") === "system") applyTheme("system");
          });
        } catch(e) {
          try { colorSchemeMQ.addListener(() => {
            if ((localStorage.getItem("theme") || "system") === "system") applyTheme("system");
          }); } catch(_){}
        }
        setupSelector('#theme-selector', 'theme', applyTheme, 'system');

        setupSelector('#density-selector', 'density', (val) => root.setAttribute('data-density', val), 'cozy');


        // Mode édition (affiche/masque les poignées de drag, et bloque tout déplacement hors édition)
        const EDIT_MODE_KEY = "startpage_edit_mode_v1";
        function applyEditMode(on) {
          document.body.classList.toggle("edit-mode", !!on);
          setTileSortableEnabled(!!on);
          try { localStorage.setItem(EDIT_MODE_KEY, on ? "1" : "0"); } catch {}
        }
        const editModeToggle = $('#edit-mode-toggle');
        if (editModeToggle) {
          const saved = (() => { try { return localStorage.getItem(EDIT_MODE_KEY); } catch { return null; } })();
          const initial = saved === "1";
          editModeToggle.checked = initial;
          applyEditMode(initial);
          editModeToggle.addEventListener('change', () => applyEditMode(editModeToggle.checked));
        } else {
          applyEditMode(false);
        }

        // Action : rétablir l’ordre des tuiles
        const tilesResetToggle = $('#tiles-reset-toggle');
        if (tilesResetToggle) {
          tilesResetToggle.checked = false;
          tilesResetToggle.addEventListener('change', () => {
            if (!tilesResetToggle.checked) return;
            // Reset + re-render
            resetTileOrder();
            setupBookmarks();
            // On remet le toggle à OFF (c’est une action, pas une préférence)
            setTimeout(() => { tilesResetToggle.checked = false; }, 150);
            closePanel();
          });
        }
        
        // Toggle News
        const newsToggle = $('#news-toggle');
        const showNews = localStorage.getItem('showNews') !== 'false';
        newsToggle.checked = showNews;
        document.body.classList.toggle('news-hidden', !showNews);
        newsToggle.addEventListener('change', () => { 
            applySetting('showNews', newsToggle.checked, (val) => document.body.classList.toggle('news-hidden', !val)); 
        });

        // Toggle Chat
        const chatToggle = $('#chat-toggle'); const showChat = localStorage.getItem('showChat') !== 'false'; chatToggle.checked = showChat; document.body.classList.toggle('chat-hidden', !showChat);
        chatToggle.addEventListener('change', () => { applySetting('showChat', chatToggle.checked, (val) => document.body.classList.toggle('chat-hidden', !val)); });
    })();

    // --- Init ---
    window.addEventListener("load", () => {
      updateGreeting(); $("#clock").textContent = getTime();
      setInterval(() => { $("#clock").textContent = getTime(); if (new Date().getSeconds() === 0) updateGreeting(); }, 1000);
      setupBookmarks(); 
      getWeather();
      loadNews();
    });


    // --- Spotlight: garder le focus sur l'input quand on clique le sélecteur moteur ---
    (function focusKeeperEngineMenu(){
      const searchInput = document.getElementById("search-input");
      const engineButton = document.getElementById("engine-button");
      const engineMenu = document.getElementById("engine-menu");
      if (!searchInput || !engineButton || !engineMenu) return;

      const refocus = () => {
        try { searchInput.focus({ preventScroll: true }); }
        catch (e) { try { searchInput.focus(); } catch(_){} }
      };

      const preventFocus = (el) => {
        if (!el) return;
        const handler = (e) => { e.preventDefault(); refocus(); };
        el.addEventListener("pointerdown", handler, { passive: false, capture: true });
        el.addEventListener("mousedown", handler, { passive: false, capture: true });
        el.addEventListener("touchstart", handler, { passive: false, capture: true });
      };

      preventFocus(engineButton);

      const wireOptions = () => engineMenu.querySelectorAll(".engine-option").forEach(preventFocus);
      wireOptions();

      // Si le menu est mis à jour dynamiquement, on rebranche
      const mo = new MutationObserver(wireOptions);
      mo.observe(engineMenu, { childList: true, subtree: true });

      // Après click (toggle / selection), on refocus aussi (au cas où)
      engineButton.addEventListener("click", () => setTimeout(refocus, 0), true);
      engineMenu.addEventListener("click", (e) => {
        if (e.target && e.target.closest(".engine-option")) setTimeout(refocus, 0);
      }, true);
    })();

</script>
</body>
</html>
