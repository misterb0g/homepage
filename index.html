<!DOCTYPE html>
<html lang="fr" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Start ‚Äì Bogarts</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <main>
    <!-- Recherche Google -->
    <section class="search-bar">
      <form action="https://www.google.com/search" method="GET" target="_blank" rel="noopener">
        <input type="text" name="q" placeholder="Recherche Google‚Ä¶" autocomplete="off" autocapitalize="none" spellcheck="false" autofocus />
      </form>
    </section>

    <!-- M√©t√©o -->
    <section id="weather" class="widget">Chargement m√©t√©o‚Ä¶</section>

    <!-- ChatGPT -->
    <section class="chat">
      <form id="chat-form">
        <input id="chat-input" type="text" placeholder="Parlez avec ChatGPT‚Ä¶" autocomplete="off" />
      </form>
      <div id="chat-output" aria-live="polite"></div>
    </section>

    <!-- === MODULES / COLONNES DE FAVORIS === -->
    <section id="boards" class="boards" aria-label="Favoris"></section>
  </main>

  <!-- Control Center -->
  <aside id="cc" role="complementary" aria-label="Control Center">
    <header>Control Center</header>
    <div id="cc-content">
      <div class="cc-block">
        <h3>R√©seau</h3>
        <div id="cc-network">Chargement‚Ä¶</div>
      </div>
      <div class="cc-block">
        <h3>Batterie</h3>
        <div id="cc-battery">Chargement‚Ä¶</div>
      </div>
      <div class="cc-block">
        <h3>√âv√©nements</h3>
        <div id="cc-events" class="cc-events">Chargement‚Ä¶</div>
      </div>
      <div class="cc-block">
        <h3>Notes</h3>
        <textarea id="cc-notes" placeholder="√âcris tes notes ici‚Ä¶"></textarea>
      </div>
    </div>
  </aside>

  <!-- Ton fichier de donn√©es -->
  <script src="bookmarks.js"></script>

  <script>
  /* ============ M√âT√âO (Open-Meteo, Bruxelles) ============ */
  (async function setupWeather() {
    const el = document.getElementById('weather');
    try {
      const url = "https://api.open-meteo.com/v1/forecast?latitude=50.85&longitude=4.35&current=temperature_2m,weathercode&timezone=auto";
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const data = await r.json();
      el.textContent = `üå°Ô∏è ${Math.round(data.current.temperature_2m)}¬∞C`;
    } catch (e) {
      el.textContent = "M√©t√©o indisponible.";
      console.error('M√©t√©o:', e);
    }
  })();

  /* ============ CHATGPT ============ */
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input');
  const chatOutput = document.getElementById('chat-output');

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const q = chatInput.value.trim();
    if (!q) return;
    chatOutput.innerHTML += `<div class="user-msg">${escapeHTML(q)}</div>`;
    chatInput.value = '';
    try {
      const r = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: q })
      });
      const data = await r.json().catch(() => ({}));
      chatOutput.innerHTML += `<div class="bot-msg">${escapeHTML(data.reply || 'Pas de r√©ponse')}</div>`;
      chatOutput.scrollTop = chatOutput.scrollHeight;
    } catch (err) {
      chatOutput.innerHTML += `<div class="bot-msg">Erreur API</div>`;
    }
  });

  /* ============ MODULES / COLONNES (rendu tol√©rant) ============ */
  (function renderBoards() {
    const root = document.getElementById('boards');

    // essaie plusieurs conventions possibles
    const picks = [
      window.BOOKMARKS?.sections,
      window.BOOKMARKS?.cols,
      window.BOOKMARKS,
      window.SECTIONS,
      window.COLUMNS
    ].filter(Boolean);

    let sections = [];
    for (const c of picks) {
      if (Array.isArray(c)) { sections = c; break; }
      if (typeof c === 'object') { sections = Object.values(c); break; }
    }
    if (!Array.isArray(sections) || !sections.length) {
      root.innerHTML = '<div class="boards-empty">Aucun module trouv√© (bookmarks.js).</div>';
      return;
    }

    const normLinks = (linksLike) => {
      if (!linksLike) return [];
      // Accepte items|links|entries
      const arr = linksLike.items || linksLike.links || linksLike.entries || linksLike;
      if (!Array.isArray(arr)) return [];
      return arr.map(x => {
        if (typeof x === 'string') return { label: x, url: x };
        return {
          label: x.label || x.name || x.title || x.text || 'Lien',
          url:   x.url   || x.href || '#'
        };
      });
    };

    const html = sections.map((s) => {
      const title = s.title || s.name || s.header || 'Section';
      const links = normLinks(s);
      const items = links.map(l => `<li><a href="${escapeAttr(l.url)}" target="_blank" rel="noopener">${escapeHTML(l.label)}</a></li>`).join('');
      return `<article class="board">
        <h3 class="board-title">${escapeHTML(title)}</h3>
        <ul class="board-list">${items}</ul>
      </article>`;
    }).join('');

    root.innerHTML = html;
  })();

  function escapeHTML(s){ return (s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function escapeAttr(s){ return String(s||'').replace(/"/g,'&quot;'); }

  /* ============ √âV√âNEMENTS (Aujourd‚Äôhui / Demain / Plus tard) ============ */
  (async function setupEvents() {
    const el = document.getElementById('cc-events');
    try {
      const r = await fetch('/api/calendar?days=30', { cache: 'no-store' });
      const text = await r.text();
      if (!r.ok) { el.textContent = `Erreur API (${r.status}) : ${text}`; return; }
      const data = JSON.parse(text);
      const events = data.events || [];
      if (!events.length) { el.textContent = "Aucun √©v√©nement √† venir."; return; }

      const fmtDate = new Intl.DateTimeFormat('fr-BE', {
        weekday:'short', day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'
      });

      const startOfDay = (d) => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
      const endOfDay   = (d) => { const x = new Date(d); x.setHours(23,59,59,999); return x; };
      const now = new Date();
      const todayStart = startOfDay(now), todayEnd = endOfDay(now);
      const tomorrowStart = new Date(todayStart); tomorrowStart.setDate(tomorrowStart.getDate()+1);
      const tomorrowEnd   = new Date(todayEnd);   tomorrowEnd.setDate(tomorrowEnd.getDate()+1);
      const inRange = (date,a,b)=>date>=a&&date<=b;

      const today=[],tomorrow=[],later=[];
      for(const ev of events){
        const dt = ev.start ? new Date(ev.start) : null;
        if(!dt) continue;
        if(inRange(dt,todayStart,todayEnd)) today.push(ev);
        else if(inRange(dt,tomorrowStart,tomorrowEnd)) tomorrow.push(ev);
        else later.push(ev);
      }

      function renderItem(ev){
        const when = ev.start ? fmtDate.format(new Date(ev.start)) : '';
        const loc = ev.location ? `<div class="evt-loc">${escapeHTML(ev.location)}</div>` : '';
        const srcBadge = ev.srcLabel ? `<span class="src-badge">${escapeHTML(ev.srcLabel)}</span>` : '';
        const dataSrc = (ev.src!=null) ? ` data-src="${ev.src}"` : '';
        return `<div class="evt"${dataSrc}>
          <div class="evt-head">${srcBadge}<span class="evt-when">${when}</span></div>
          <div class="evt-title">${escapeHTML(ev.summary)}</div>
          ${loc}
        </div>`;
      }
      function renderGroup(title,arr){
        if(!arr.length) return '';
        return `<div class="evt-group">
          <h4 class="evt-group-title">${title}</h4>
          <div class="evt-list">${arr.map(renderItem).join('')}</div>
        </div>`;
      }

      el.innerHTML =
        renderGroup("Aujourd‚Äôhui", today) +
        renderGroup("Demain", tomorrow) +
        renderGroup("Plus tard", later);
    } catch(e){
      el.textContent = "Impossible de charger les √©v√©nements.";
      console.error('Events:', e);
    }
  })();

  /* ============ R√©seau, Batterie, Notes ============ */
  (function setupNetwork() {
    const el = document.getElementById('cc-network');
    const update = () => el.textContent = navigator.onLine ? 'En ligne' : 'Hors ligne';
    window.addEventListener('online', update);
    window.addEventListener('offline', update);
    update();
  })();
  (async function setupBattery(){
    const el = document.getElementById('cc-battery');
    try {
      if (!navigator.getBattery) { el.textContent = 'Non disponible'; return; }
      const b = await navigator.getBattery();
      const render = () => { const pct = Math.round(b.level * 100); el.textContent = `${pct}% ${b.charging ? '‚ö°Ô∏é' : ''}`; };
      ['levelchange','chargingchange'].forEach(ev => b.addEventListener(ev, render));
      render();
    } catch { el.textContent = 'Non disponible'; }
  })();
  (function setupNotes(){
    const el = document.getElementById('cc-notes');
    const KEY = 'cc-notes';
    el.value = localStorage.getItem(KEY) || '';
    el.addEventListener('input', () => localStorage.setItem(KEY, el.value));
  })();
  </script>
</body>
</html>
