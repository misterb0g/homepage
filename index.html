<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Homepage</title>

    <link rel="preload" href="styles.css" as="style">
    <link rel="stylesheet" href="styles.css">

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <link rel="icon" href="favicon.png" />
  </head>
  <body>
    <div class="top-controls">
      <button id="theme-toggle-btn" class="btn-icon" aria-pressed="false" title="Basculer clair/sombre" aria-label="Basculer le thème">
        <svg id="theme-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M12 4.5V2m0 20v-2.5M4.5 12H2m20 0h-2.5M5.6 5.6 4 4m16 16-1.6-1.6M5.6 18.4 4 20m16-16-1.6 1.6"/>
          <circle cx="12" cy="12" r="4.5"/>
        </svg>
      </button>

      <button id="density-toggle" class="btn-icon" aria-pressed="false" title="Basculer densité (compacte/spacieuse)" aria-label="Basculer la densité">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M8.2 16h1.9l.6-1.7h2.7l.6 1.7h1.9L12.9 8h-1.8L8.2 16zm3.1-3.3l1-2.7 1 2.7h-2z" />
          <path d="M17 6.5l1.4 1.4-.9.9V9h-1V8.8l-.9-.9L17 6.5zm0 11l-1.4-1.4.9-.9V15h1v.2l.9.9L17 17.5zM16.5 9v6h1V9h-1z"/>
        </svg>
      </button>
    </div>

    <div class="container">
      <div id="clock" aria-label="Heure actuelle"></div>

      <section id="weather" class="card glass weather-container" aria-live="polite" tabindex="0" role="button" aria-expanded="false" aria-controls="weather-details" title="Cliquer pour afficher les prévisions 5 jours">
        <div class="row">
          <div id="weather-description" class="inline"></div>
          <div class="inline">•</div>
          <div id="temp" class="inline"></div>
        </div>
      </section>
      <section id="weather-details" class="card glass weather-details" hidden></section>

      <form class="spotlight glass" action="https://www.google.com/search" method="GET" target="_self" role="search" aria-label="Recherche">
        <input type="search" name="q" placeholder="Rechercher…" inputmode="search" autocapitalize="off" autocorrect="off" spellcheck="false" required aria-label="Votre recherche" />
        <button type="submit" class="visually-hidden">Rechercher</button>
      </form>

      <div id="bookmark-container"></div>

      <section id="gpt-chat" class="card glass">
        <h2>ChatGPT</h2>
        <div id="gpt-messages" aria-live="polite" aria-busy="false"></div>
        <form id="gpt-form" autocomplete="off">
          <input id="gpt-input" type="text" name="prompt" placeholder="Pose ta question…" inputmode="text" required aria-label="Message pour ChatGPT" />
          <button type="submit">Envoyer</button>
        </form>
        <p class="hint">Astuce : / ou ⌘K / Ctrl+K → focus barre Google • Densité via l’icône “A↕︎”.</p>
      </section>

      <section id="net-battery-container" class="card glass footer-card">
        <div class="footer-item">
          <svg viewBox="0 0 24 24"><path d="M2 18a10 10 0 0 1 20 0h-2a8 8 0 0 0-16 0H2zm4 0a6 6 0 0 1 12 0h-2a4 4 0 0 0-8 0H6zm4 0a2 2 0 1 1 4 0h-4z"/></svg>
          <span id="net-status-display"></span>
        </div>
        <div class="footer-item" id="battery-item" hidden>
          <svg viewBox="0 0 24 24"><path d="M16 7H5a3 3 0 0 0-3 3v4a3 3 0 0 0 3 3h11a3 3 0 0 0 3-3V10a3 3 0 0 0-3-3zm5 4v2a1 1 0 0 1-2 0v-2a1 1 0 1 1 2 0z"/></svg>
          <span id="battery-status-display"></span>
        </div>
      </section>

    <script src="bookmarks.js"></script>
    <script>
      const $ = (sel, root = document) => root.querySelector(sel);

      /* Horloge */
      function getTime() {
        const d = new Date();
        const pad = (n) => (n < 10 ? "0" + n : n);
        return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      }

      /* Météo (Open-Meteo) */
      const BRU = { lat: 50.8503, lon: 4.3517, tz: 'Europe/Brussels' };

      function getWeather() {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${BRU.lat}&longitude=${BRU.lon}&current=temperature_2m,weather_code&timezone=${encodeURIComponent(BRU.tz)}&forecast_days=1`;
        fetch(url)
          .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
          .then(data => {
            let t = data?.current?.temperature_2m;
            let wcode = data?.current?.weather_code;
            if (t == null && data?.current_weather?.temperature != null) t = Math.round(data.current_weather.temperature);
            else if (t != null) t = Math.round(t);
            if (wcode == null && data?.current_weather?.weathercode != null) wcode = data.current.weathercode;

            if (t == null || wcode == null) throw new Error("Structure inattendue");
            $("#temp").textContent = `${t} °C`;
            $("#weather-description").textContent = weatherCodeToFr(wcode);
          })
          .catch(err => {
            console.error("Météo:", err);
            const card = $("#weather");
            if (card) card.innerHTML = `<div class="inline">Météo indisponible</div>`;
          });
      }

      const WEATHER_CACHE_KEY = 'weather5d_cache_v1';
      const WEATHER_TTL_MS = 60 * 60 * 1000;

      function getWeather5dCached() {
        try {
          const raw = localStorage.getItem(WEATHER_CACHE_KEY);
          if (raw) {
            const { ts, data } = JSON.parse(raw);
            if (data && Date.now() - ts < WEATHER_TTL_MS) return Promise.resolve(data);
          }
        } catch {}
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${BRU.lat}&longitude=${BRU.lon}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=${encodeURIComponent(BRU.tz)}&forecast_days=5`;
        return fetch(url)
          .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
          .then(data => {
            if (!data?.daily?.time || !data?.daily?.weather_code) throw new Error("Structure inattendue daily");
            try { localStorage.setItem(WEATHER_CACHE_KEY, JSON.stringify({ ts: Date.now(), data })); } catch {}
            return data;
          })
          .catch(err => {
            console.error("Météo (5j):", err);
            try { const raw = localStorage.getItem(WEATHER_CACHE_KEY); if (raw) { const { data } = JSON.parse(raw); if (data) return data; } } catch {}
            throw err;
          });
      }

      function weatherCodeToFr(code) {
        const map = {0:"Ciel dégagé",1:"Plutôt dégagé",2:"Partiellement nuageux",3:"Couvert",45:"Brouillard",48:"Brouillard givrant",51:"Bruine légère",53:"Bruine",55:"Bruine forte",61:"Pluie légère",63:"Pluie",65:"Pluie forte",66:"Pluie verglaçante légère",67:"Pluie verglaçante forte",71:"Neige légère",73:"Neige",75:"Neige forte",77:"Grains de neige",80:"Averses faibles",81:"Averses",82:"Averses fortes",85:"Averses de neige faibles",86:"Averses de neige fortes",95:"Orages",96:"Orages (grésil)",99:"Orages (grêle)"};
        return map[code] ?? "Météo";
      }

      function renderWeather5d(data) {
        const days = data.daily.time.map((d, i) => ({ date: d, code: data.daily.weather_code[i], tmax: Math.round(data.daily.temperature_2m_max[i]), tmin: Math.round(data.daily.temperature_2m_min[i]) }));
        const df = new Intl.DateTimeFormat('fr-BE', { weekday: 'long', day: 'numeric', month: 'short' });
        const html = ["<div class='weather5d'>", ...days.map((day) => `
          <div class="weather-day">
            <div class="wd-date">${df.format(new Date(day.date))}</div>
            <div class="wd-desc">${weatherCodeToFr(day.code)}</div>
            <div class="wd-temps"><span class="max">${day.tmax}°</span> / <span class="min">${day.tmin}°</span></div>
          </div>`), "</div>"].join("");
        $("#weather-details").innerHTML = html;
      }

      /* Favoris */
      function setupBookmarks() {
        const el = $("#bookmark-container");
        el.innerHTML = bookmarks.map((b) => {
          const html = ["<section class='bookmark-set card glass'>"];
          html.push(`<div class="bookmark-title">${b.title}</div>`);
          html.push('<div class="bookmark-inner-container">');
          html.push(...b.links.map((l) => `<a class="bookmark" href="${l.url}" target="_blank" rel="noopener noreferrer">${l.name}</a>`));
          html.push("</div></section>");
          return html.join("");
        }).join("");
      }

      /* Thème (icône) */
      (function () {
        const root = document.documentElement;
        const btn = $("#theme-toggle-btn");
        const icon = $("#theme-icon");

        function setIcon(theme) {
          icon.innerHTML = (theme === "light")
            ? '<path d="M12 4.5V2m0 20v-2.5M4.5 12H2m20 0h-2.5M5.6 5.6 4 4m16 16-1.6-1.6M5.6 18.4 4 20m16-16-1.6 1.6"/><circle cx="12" cy="12" r="4.5"/>'
            : '<path d="M21 12.7A9 9 0 1 1 11.3 3a7 7 0 1 0 9.7 9.7z"/>';
        }

        const saved = localStorage.getItem("theme");
        let theme = (saved === "light" || saved === "dark")
          ? saved
          : (matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");

        root.setAttribute("data-theme", theme);
        btn.setAttribute("aria-pressed", theme === "light");
        setIcon(theme);

        btn.addEventListener("click", () => {
          theme = (root.getAttribute("data-theme") === "light") ? "dark" : "light";
          root.setAttribute("data-theme", theme);
          localStorage.setItem("theme", theme);
          btn.setAttribute("aria-pressed", theme === "light");
          setIcon(theme);
        });
      })();

      /* Densité */
      (function () {
        const root = document.documentElement;
        const btn = $("#density-toggle");
        const saved = localStorage.getItem("density") || "cozy";
        root.setAttribute("data-density", saved);
        btn.setAttribute("aria-pressed", saved === "compact" ? "true" : "false");
        btn.addEventListener("click", () => {
          const current = root.getAttribute("data-density") === "compact" ? "cozy" : "compact";
          root.setAttribute("data-density", current);
          btn.setAttribute("aria-pressed", current === "compact" ? "true" : "false");
          localStorage.setItem("density", current);
        });
      })();

      /* Raccourcis Spotlight */
      window.addEventListener("keydown", (e) => {
        const spotlight = $(".spotlight input[type='search']");
        if (!spotlight) return;
        const activeTag = document.activeElement.tagName.toLowerCase();
        if (activeTag === "input" || activeTag === "textarea") return;
        if (e.key === "/" && !e.metaKey && !e.ctrlKey) { e.preventDefault(); spotlight.focus(); return; }
        if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "k") { e.preventDefault(); spotlight.focus(); }
      });

      /* ChatGPT */
      (function () {
        const form = $("#gpt-form"), input = $("#gpt-input"), messages = $("#gpt-messages");
        function addBubble(text, who = 'you', pending = false) {
          const div = document.createElement('div');
          div.className = `msg ${who}` + (pending ? ' pending' : '');
          div.textContent = text; messages.appendChild(div);
          messages.scrollTop = messages.scrollHeight; return div;
        }
        form.addEventListener('submit', async (e) => {
          e.preventDefault(); const prompt = input.value.trim(); if (!prompt) return;
          addBubble(prompt, 'you'); input.value = '';
          const bot = addBubble('', 'bot', true);
          try {
            const res = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ prompt }) });
            if (!res.ok) { const errText=await res.text(); bot.classList.remove('pending'); bot.textContent=`Erreur API (${res.status}) : ${errText}`; return; }
            if (!res.body) throw new Error('Pas de flux de réponse');
            const reader = res.body.getReader(); const decoder = new TextDecoder('utf-8'); let acc = '';
            for (;;) { const {value,done}=await reader.read(); if(done) break;
              acc += decoder.decode(value,{stream:true}); bot.textContent = acc; messages.scrollTop = messages.scrollHeight; }
            bot.classList.remove('pending');
          } catch(err){ bot.classList.remove('pending'); bot.textContent="Erreur réseau/JS. Voir console."; console.error(err); }
        });
      })();

      /* Interactions météo (toggle détails) */
      (function () {
        const weatherCard = $("#weather");
        const details = $("#weather-details");
        let loaded = false;

        async function toggleDetails() {
          const isHidden = details.hasAttribute("hidden");
          if (isHidden && !loaded) {
            try { const data = await getWeather5dCached(); renderWeather5d(data); loaded = true; }
            catch { details.innerHTML = "<div class='wd-error'>Impossible de charger les prévisions.</div>"; }
          }
          details.toggleAttribute("hidden");
          const expanded = !details.hasAttribute("hidden");
          weatherCard.setAttribute("aria-expanded", expanded ? "true" : "false");
        }

        weatherCard.addEventListener("click", toggleDetails);
        weatherCard.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleDetails(); } });
      })();

      /* Nouveau script pour le bloc Réseau et Batterie */
      (function () {
        async function updateNetworkStatus() {
          const netStatusEl = document.getElementById('net-status-display');
          let ip = "IP inconnue";
          try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            ip = data.ip || "IP inconnue";
          } catch (e) {
            console.error("Erreur de récupération de l'IP :", e);
          }
          const connectionType = navigator.connection ? navigator.connection.effectiveType.toUpperCase() : "Inconnu";
          netStatusEl.textContent = `En ligne • ${ip} • ${connectionType}`;
        }

        async function updateBatteryStatus() {
          const batteryItem = document.getElementById('battery-item');
          const batteryStatusEl = document.getElementById('battery-status-display');
          try {
            if (!('getBattery' in navigator)) {
              batteryItem.hidden = true;
              return;
            }
            const battery = await navigator.getBattery();
            batteryItem.hidden = false;
            const updateDisplay = () => {
              batteryStatusEl.textContent = `${Math.round(battery.level * 100)}% (${battery.charging ? 'En charge' : 'Sur batterie'})`;
            };
            updateDisplay();
            battery.addEventListener('levelchange', updateDisplay);
            battery.addEventListener('chargingchange', updateDisplay);
          } catch (e) {
            console.error("Erreur de récupération de la batterie :", e);
            batteryItem.hidden = true;
          }
        }
        
        // Initialisation des deux fonctions
        updateNetworkStatus();
        updateBatteryStatus();

        // Mettre à jour l'état du réseau en cas de changement
        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);
      })();


      /* Init */
      window.addEventListener("load", () => {
        $("#clock").textContent = getTime();
        setInterval(() => ($("#clock").textContent = getTime()), 1000);

        setupBookmarks();
        getWeather();
      });
    </script>
  </body>
</html>