<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>start.bogarts — Accueil</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="app">
    <header class="topbar glass">
      <div class="brand">
        <span class="logo" aria-hidden="true">⌘</span>
        <span class="title">Start</span>
      </div>
      <div class="toggles">
        <button id="themeToggle" class="btn-icon" title="Basculer thème" aria-label="Basculer thème">
          <svg viewBox="0 0 24 24" class="icon"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"/></svg>
        </button>
        <button id="densityToggle" class="btn-icon" title="Basculer densité" aria-label="Basculer densité">
          <svg viewBox="0 0 24 24" class="icon"><path d="M3 6h18M3 12h18M3 18h18" stroke-linecap="round"/></svg>
        </button>
      </div>
    </header>

    <main class="grid">
      <!-- Column: Search / Chat -->
      <section class="stack">
        <article class="card glass">
          <header class="card-head">
            <div class="card-title">
              <svg viewBox="0 0 24 24" class="icon"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/></svg>
              <h2>Recherche</h2>
            </div>
          </header>
          <div class="card-body">
            <form class="row" action="https://www.google.com/search" method="GET" target="_blank" role="search" aria-label="Recherche Google">
              <input type="text" name="q" class="input" placeholder="Rechercher sur Google…" autocomplete="on" required />
              <button class="btn">Google</button>
            </form>
          </div>
        </article>

        <article class="card glass">
          <header class="card-head">
            <div class="card-title">
              <svg viewBox="0 0 24 24" class="icon"><path d="M21 15a4 4 0 01-4 4H8l-5 3V7a4 4 0 014-4h10a4 4 0 014 4z"/></svg>
              <h2>ChatGPT</h2>
            </div>
          </header>
          <div class="card-body">
            <form id="chatForm" class="row" autocomplete="off">
              <input id="chatInput" class="input" placeholder="Pose-moi une question…" required />
              <button class="btn" type="submit">Envoyer</button>
            </form>
            <div id="chatOutput" class="output" aria-live="polite"></div>
          </div>
          <footer class="card-foot hint">Utilise ton endpoint <code>/api/chat</code> (Next.js) si disponible.</footer>
        </article>

        <article class="card glass">
          <header class="card-head">
            <div class="card-title">
              <svg viewBox="0 0 24 24" class="icon"><path d="M4 6h16M4 12h10M4 18h7"/></svg>
              <h2>Favoris</h2>
            </div>
            <div class="actions">
              <button id="addToggle" class="btn-ghost">Ajouter</button>
            </div>
          </header>
          <div class="card-body">
            <form id="addForm" class="row add-form" hidden>
              <input id="bmTitle" class="input" placeholder="Titre (ex. Gmail)" />
              <input id="bmUrl" class="input" placeholder="URL (https://…)" />
              <button class="btn" type="submit">+ Ajouter</button>
            </form>
            <div id="bookmarks" class="bookmarks-grid"></div>
            <div class="hint">Astuce : clique-droit ou appui long sur une tuile pour la supprimer.</div>
          </div>
        </article>
      </section>

      <!-- Column: Weather -->
      <section class="stack">
        <article class="card glass">
          <header class="card-head">
            <div class="card-title">
              <svg viewBox="0 0 24 24" class="icon"><path d="M6 19a7 7 0 1112.12-5.12A4.5 4.5 0 1118 19z"/></svg>
              <h2>Météo</h2>
            </div>
            <button id="refreshWeather" class="btn-ghost">Actualiser</button>
          </header>
          <div class="card-body">
            <div class="weather">
              <div class="weather-main">
                <div class="temp" id="temp">--°</div>
                <div class="cond" id="cond">—</div>
              </div>
              <div class="weather-meta">
                <div id="city">Localisation…</div>
                <div id="meta">Vent — • Humidité —</div>
              </div>
            </div>
          </div>
          <footer class="card-foot hint">Source : <a href="https://open-meteo.com/" target="_blank" rel="noreferrer">Open-Meteo</a></footer>
        </article>
      </section>
    </main>

    <footer class="footer">
      <small>© <span id="year"></span> Gilles Bogarts — start.bogarts.be</small>
    </footer>
  </div>

  <script>
    // ===== Utils =====
    const $ = (s, r = document) => r.querySelector(s);
    const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

    // ===== Theme & Density Toggles =====
    const themeToggle = $('#themeToggle');
    const densityToggle = $('#densityToggle');

    const applyTheme = (t) => {
      document.documentElement.dataset.theme = t;
      localStorage.setItem('theme', t);
    };
    const applyDensity = (d) => {
      document.documentElement.dataset.density = d;
      localStorage.setItem('density', d);
    };

    const initPrefs = () => {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
      const density = localStorage.getItem('density') || 'comfortable';
      applyTheme(theme);
      applyDensity(density);
    };

    themeToggle.addEventListener('click', () => {
      const next = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
      applyTheme(next);
    });
    densityToggle.addEventListener('click', () => {
      const next = document.documentElement.dataset.density === 'compact' ? 'comfortable' : 'compact';
      applyDensity(next);
    });

    // ===== Year =====
    $('#year').textContent = new Date().getFullYear();

    // ===== Chat Form (calls /api/chat if present) =====
    const chatForm = $('#chatForm');
    const chatInput = $('#chatInput');
    const chatOutput = $('#chatOutput');

    async function callChatAPI(message) {
      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        if (!res.ok) throw new Error('Endpoint non disponible');
        const data = await res.json();
        return data.reply || JSON.stringify(data);
      } catch (e) {
        return '⚠️ Impossible de contacter /api/chat. Vérifie ton endpoint côté serveur.';
      }
    }

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = chatInput.value.trim();
      if (!q) return;
      chatOutput.textContent = '…';
      const reply = await callChatAPI(q);
      chatOutput.textContent = reply;
      chatInput.value = '';
    });

    // ===== Bookmarks =====
    const bmGrid = $('#bookmarks');
    const addToggle = $('#addToggle');
    const addForm = $('#addForm');
    const bmTitle = $('#bmTitle');
    const bmUrl = $('#bmUrl');
    const BM_KEY = 'bookmarks@start.bogarts';

    const DEFAULT_BM = [
      { title: 'Gmail', url: 'https://mail.google.com' },
      { title: 'Agenda', url: 'https://calendar.google.com' },
      { title: 'Drive', url: 'https://drive.google.com' },
      { title: 'GitHub', url: 'https://github.com' },
      { title: 'Vercel', url: 'https://vercel.com' },
      { title: 'Le Silex', url: 'https://lesilex.be' },
      { title: 'Start – Admin', url: 'https://start.bogarts.be' }
    ];

    function normalizeUrl(u) {
      try {
        if (!/^https?:\/\//i.test(u)) u = 'https://' + u;
        return new URL(u).toString();
      } catch { return ''; }
    }

    function loadBM() {
      try {
        const raw = localStorage.getItem(BM_KEY);
        return raw ? JSON.parse(raw) : DEFAULT_BM;
      } catch { return DEFAULT_BM; }
    }
    function saveBM(list) {
      localStorage.setItem(BM_KEY, JSON.stringify(list));
    }

    function favicon(url) {
      try {
        const u = new URL(url);
        return `https://www.google.com/s2/favicons?domain=${u.hostname}&sz=64`;
      } catch { return ''; }
    }

    function renderBM() {
      const list = loadBM();
      bmGrid.innerHTML = '';
      list.forEach((bm, idx) => {
        const a = document.createElement('a');
        a.className = 'bm';
        a.href = bm.url;
        a.target = '_blank';
        a.rel = 'noreferrer';
        a.innerHTML = \`
          <img class="bm-ico" alt="" src="\${favicon(bm.url)}">
          <span class="bm-title">\${bm.title}</span>
        \`;
        // Delete on contextmenu (right-click) or long-press
        let pressTimer;
        const longPressMs = 600;
        const askDelete = (ev) => {
          ev.preventDefault();
          if (confirm('Supprimer ce favori ?')) {
            const arr = loadBM();
            arr.splice(idx, 1);
            saveBM(arr);
            renderBM();
          }
        };
        a.addEventListener('contextmenu', askDelete);
        a.addEventListener('touchstart', () => {
          pressTimer = setTimeout(() => askDelete(new Event('contextmenu')), longPressMs);
        }, {passive: true});
        a.addEventListener('touchend', () => clearTimeout(pressTimer));
        bmGrid.appendChild(a);
      });
    }

    addToggle.addEventListener('click', () => {
      addForm.hidden = !addForm.hidden;
      if (!addForm.hidden) bmTitle.focus();
    });

    addForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const title = bmTitle.value.trim();
      const url = normalizeUrl(bmUrl.value.trim());
      if (!title || !url) return;
      const list = loadBM();
      list.push({ title, url });
      saveBM(list);
      bmTitle.value = '';
      bmUrl.value = '';
      addForm.hidden = true;
      renderBM();
    });

    // ===== Weather (Open-Meteo) =====
    const weatherEls = {
      temp: $('#temp'),
      cond: $('#cond'),
      city: $('#city'),
      meta: $('#meta')
    };

    const WMO = {
      0: 'Ciel clair',
      1: 'Peu nuageux',
      2: 'Variable',
      3: 'Couvert',
      45: 'Brouillard',
      48: 'Brouillard givrant',
      51: 'Bruine légère',
      53: 'Bruine',
      55: 'Bruine forte',
      61: 'Pluie faible',
      63: 'Pluie',
      65: 'Pluie forte',
      71: 'Neige faible',
      73: 'Neige',
      75: 'Neige forte',
      95: 'Orage',
      96: 'Orage (grêle)',
      99: 'Orage (forte grêle)'
    };

    function kmh(ms) { return Math.round(ms * 3.6); }

    async function fetchWeather(lat, lon) {
      const url = \`https://api.open-meteo.com/v1/forecast?latitude=\${lat}&longitude=\${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto\`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Météo indisponible');
      const data = await res.json();
      const c = data.current;
      weatherEls.temp.textContent = Math.round(c.temperature_2m) + '°';
      weatherEls.cond.textContent = WMO[c.weather_code] || '—';
      weatherEls.meta.textContent = \`Vent \${kmh(c.wind_speed_10m)} km/h • Humidité \${c.relative_humidity_2m}%\`;
    }

    async function reverseGeocode(lat, lon) {
      try {
        const res = await fetch(\`https://nominatim.openstreetmap.org/reverse?format=json&lat=\${lat}&lon=\${lon}\`);
        if (!res.ok) throw new Error('');
        const data = await res.json();
        return data.address?.city || data.address?.town || data.address?.village || data.address?.municipality || 'Position';
      } catch {
        return 'Position';
      }
    }

    async function loadWeather() {
      weatherEls.city.textContent = 'Localisation…';
      try {
        const pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 5000 });
        });
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const city = await reverseGeocode(lat, lon);
        weatherEls.city.textContent = city;
        await fetchWeather(lat, lon);
      } catch {
        // Fallback Brussels
        const lat = 50.8503, lon = 4.3517;
        weatherEls.city.textContent = 'Bruxelles (défaut)';
        await fetchWeather(lat, lon);
      }
    }

    $('#refreshWeather').addEventListener('click', loadWeather);

    // Init
    initPrefs();
    renderBM();
    loadWeather();
  </script>
</body>
</html>
